<button id="leaderboardButton">Таблица лидеров</button>

<div id="leaderboardSection">
    <h2>Таблица лидеров</h2>
    <table>
        <thead>
            <tr>
                <th>Имя</th>
                <th>Очки</th>
            </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AlzaSyCf_H8MkMhYJioAcTHac8bX8gC0MKand8",
        authDomain: "kavunkoin.firebaseapp.com",
        databaseURL: "https://kavunkoin-default-rtdb.firebaseio.com",
        projectId: "kavunkoin",
        storageBucket: "kavunkoin.appspot.com",
        messagingSenderId: "825488580549",
        appId: "1:825488580549:web:8ae4b6c4016de71b907d6a"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let score = 0;
    let upgradeCost = 50;
    let clickPower = 1;

    // Обработка кликов
    document.getElementById('clickImage').addEventListener('click', () => {
        score += clickPower;
        document.getElementById('score').textContent = score;
    });

    // Обработка улучшений
    document.getElementById('upgrade').addEventListener('click', () => {
        if (score >= upgradeCost) {
            score -= upgradeCost;
            clickPower++;
            upgradeCost += 20;
            document.getElementById('score').textContent = score;
            document.getElementById('upgrade').textContent = `Улучшение (${upgradeCost} очков)`;
        } else {
            alert("Недостаточно очков!");
        }
    });

    // Загрузка данных таблицы лидеров
    const loadLeaderboard = async () => {
        const leaderboardBody = document.getElementById('leaderboardBody');
        leaderboardBody.innerHTML = ""; // Очищаем таблицу перед загрузкой данных

        const snapshot = await get(ref(database, 'players'));
        if (snapshot.exists()) {
            const players = snapshot.val();
            const sortedPlayers = Object.entries(players).sort(([, a], [, b]) => b.score - a.score);

            sortedPlayers.forEach(([name, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${name}</td><td>${data.score}</td>`;
                leaderboardBody.appendChild(row);
            });
        } else {
            leaderboardBody.innerHTML = "<tr><td colspan='2'>Нет данных</td></tr>";
        }
    };

    // Обработка кнопки таблицы лидеров
    document.getElementById('leaderboardButton').addEventListener('click', () => {
        const leaderboardSection = document.getElementById('leaderboardSection');
        leaderboardSection.style.display = 
            leaderboardSection.style.display === 'none' ? 'block' : 'none';

        if (leaderboardSection.style.display === 'block') {
            loadLeaderboard();
        }
    });

    // Авторизация игрока
    document.getElementById('login').addEventListener('click', async () => {
        playerName = document.getElementById('playerName').value;
        password = document.getElementById('password').value;

        if (playerName && password) {
            const playerRef = ref(database, 'players/' + playerName);
            const snapshot = await get(playerRef);

            if (snapshot.exists()) {
                const storedPassword = snapshot.val().password;
                if (storedPassword === password) {
                    score = snapshot.val().score || 0;
                    clickPower = snapshot.val().clickPower || 1;
                    upgradeCost = snapshot.val().upgradeCost || 50;
                    document.getElementById('score').textContent = score;
                    document.getElementById('upgrade').textContent = `Улучшение (${upgradeCost} очков)`;
                    alert("Вход выполнен успешно!");
                    hideModal();
                } else {
                    alert("Неверный пароль!");
                }
            } else {
                alert("Игрок с таким именем не найден!");
            }
        } else {
            alert("Введите ник и пароль!");
        }
    });
</script>
